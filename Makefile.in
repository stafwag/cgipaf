# ----------------------------------------------------------------------
# (GPL) 2001,2004 Belgium                               http://staf.patat.org
# Staf Wagemakers	                                  staf@patat.org
# ----------------------------------------------------------------------

ARG=-D_@ARG@ -D@NEED_COMPAT_H@
OBJS=@OBJS@

prefix          = @prefix@
exec_prefix     = @exec_prefix@
top_srcdir      = @top_srcdir@
bindir          = @bindir@
libexecdir      = @libexecdir@
sysconfdir      = @sysconfdir@
localstatedir   = @localstatedir@
srcdir          = @srcdir@
HAVE_GDBMDIR_NDBM_H   = -D@HAVE_GDBMDIR_NDBM_H@
inc_files       = msg.h cgipaf_defs.h cgipaf_vars.h cgipaf_acl.c cgipaf_auth.c cgipaf_checkpw.c cgipaf_createauthcookie.c cgipaf_getlogindata.c  cgipaf_pwlocation.c cgipaf_updatepw.c cgipaf_init.c
CC=@CC@
CFLAGS=@CFLAGS@

CONFIGFILE=$(sysconfdir)/cgipaf.conf

all: passwd.cgi viewmailcfg.cgi mailcfg.cgi pwadmin.cgi mailadmin.cgi changepass

passwd.cgi: cgipaf.c ${OBJS} ${inc_files}
	$(CC) $(CFLAGS) -o passwd.cgi cgipaf.c ${OBJS} @LIBS@ ${ARG} -DCONFIGFILE=\"$(CONFIGFILE)\" -DCGIPAF_PASSWD

pwadmin.cgi: cgipafadmin.c ${OBJS} ${inc_files}
	$(CC) $(CFLAGS) -o pwadmin.cgi cgipafadmin.c ${OBJS} @LIBS@ ${ARG} -DCONFIGFILE=\"$(CONFIGFILE)\" -DCGIPAF_PWADMIN

mailcfg.cgi: mailcfg.c ${OBJS} mailconfig.o ${inc_files}
	$(CC) $(CFLAGS) -o mailcfg.cgi mailcfg.c ${OBJS} mailconfig.o @LIBS@ ${ARG} -DCONFIGFILE=\"$(CONFIGFILE)\" -DCGIPAF_MAILCFG

viewmailcfg.cgi: cgipaf.c ${OBJS} mailconfig.o ${inc_files}
	$(CC) $(CFLAGS) -o viewmailcfg.cgi cgipaf.c ${OBJS} mailconfig.o @LIBS@ ${ARG} -DCONFIGFILE=\"$(CONFIGFILE)\" -DCGIPAF_VIEWMAILCFG
	
mailadmin.cgi: cgipafadmin.c ${OBJS} ${inc_files}
	$(CC) $(CFLAGS) -o mailadmin.cgi cgipafadmin.c ${OBJS} mailconfig.o @LIBS@ ${ARG} -DCONFIGFILE=\"$(CONFIGFILE)\" -DCGIPAF_MAILADMIN

changepass: changepass.c ${OBJS} ${inc_files}
	$(CC) $(CFLAGS) -o changepass changepass.c ${OBJS} @LIBS@ ${ARG} 

install: all
	 su root -c "/bin/sh ./install.sh"

pass.o: pass.c pass.h
	$(CC) $(CFLAGS) -c pass.c

passpam.o: passpam.c pass.h
	   $(CC) $(CFLAGS) $(ARG) -c passpam.c 

ccgi.o: ccgi.c ccgi.h
	$(CC) $(CFLAGS) -c ccgi.c
	
configfile.o: configfile.c configfile.h xstring.o
	$(CC) $(CFLAGS) -c configfile.c

xstring.o: xstring.c xstring.h
	   $(CC) $(CFLAGS) -c xstring.c
	   
ephp.o: ephp.c ephp.h xstring.o
	$(CC) $(CFLAGS) -c ephp.c

showmsg.o: showmsg.c showmsg.h configfile.o
	$(CC) $(CFLAGS) -c showmsg.c

accessdb.o: accessdb.c accessdb.h
	$(CC) $(CFLAGS) -c accessdb.c ${HAVE_GDBMDIR_NDBM_H}

createcookie.o: createcookie.c createcookie.h
	$(CC) $(CFLAGS) -c createcookie.c

mailconfig.o: mailconfig.h mailconfig.c pass.h searchdomain.o
	$(CC) $(CFLAGS) $(ARG) -c mailconfig.c
	
compat.o: compat.c compat.h
	$(CC) $(CFLAGS) -c compat.c
	
searchdomain.o: searchdomain.c searchdomain.h xstring.o configfile.o
	$(CC) $(CFLAGS) $(ARG) -c searchdomain.c

xmalloc.o:  xmalloc.c xmalloc.h out_of_memory.o
	$(CC) $(CFLAGS) -c xmalloc.c

out_of_memory.o:  out_of_memory.c out_of_memory.h write_log.o
	$(CC) $(CFLAGS) -c out_of_memory.c

run_cmd.o: run_cmd.c run_cmd.h configfile.o
	$(CC) $(CFLAGS) $(ARG) -c run_cmd.c

md5.o:	md5.c md5.h
	$(CC) $(CFLAGS) -c md5.c

md5crypt.o:  md5crypt.c md5crypt.h md5.o
	$(CC) $(CFLAGS) -c md5crypt.c

salt.o:	salt.c salt.h
	$(CC) $(CFLAGS) -c salt.c

write_log.o: write_log.c write_log.h 
	$(CC) $(CFLAGS) -c write_log.c

acl.o: acl.c acl.h 
	$(CC) $(CFLAGS) -c acl.c

fgetpwnam.o: fgetpwnam.c fgetpwnam.h
	$(CC) $(CFLAGS) -c fgetpwnam.c

cgipaf_func.o: cgipaf_func.c cgipaf_func.h xstring.o ccgi.o
	$(CC) $(CFLAGS) -c cgipaf_func.c

clean:
	rm -f *.cgi *.o changepass

distclean: dist-clean
dist-clean: clean
	rm -f config.cache config.h config.log config.status
	rm -f Makefile
	rm -f install.sh
	rm -f createconfig.sh
	rm -f cgipaf.conf
	rm -f *~
